<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pulse Cloud Runner</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f4f6f8;
      margin: 2rem;
      color: #222;
    }
    h1 {
      color: #007bff;
    }
    form {
      background: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      max-width: 500px;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
    }
    input, select, button {
      margin-top: 0.5rem;
      padding: 0.5rem;
      width: 100%;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      background: #007bff;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
      transition: background 0.2s;
    }
    button:hover {
      background: #0056b3;
    }

    /* --- CHARTS LAYOUT --- */
    .charts {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1.2rem;
      margin-top: 2rem;
    }

    .chart-box {
      background: #fff;
      border-radius: 10px;
      padding: 1rem 1.2rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      height: 280px;
    }

    .chart-title {
      text-align: left;
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .chart-box canvas {
      flex: 1;
      width: 100% !important;
      height: 100% !important;
    }

    /* --- TABLE --- */
    .table-container {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      overflow: hidden;
      margin-top: 2rem;
      max-height: 300px;
      overflow-y: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }

    th {
      background: #007bff;
      color: white;
      font-size: 0.9rem;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    /* --- LOGS --- */
    #logs {
      background: #111;
      color: #0f0;
      padding: 1rem;
      height: 250px;
      overflow-y: auto;
      margin-top: 2rem;
      border-radius: 8px;
      font-family: monospace;
    }

    @media (max-width: 900px) {
      .charts {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h1>‚ö° Pulse Cloud Runner</h1>

  <form id="runForm">
    <label>YAML File:</label>
    <input type="file" id="file" accept=".yaml,.yml" required />

    <!-- üëá NUEVO: Selector de n√∫mero de nodos -->
    <label>Number of Nodes:</label>
    <select id="nodeCount">
      <option value="1">1 Node</option>
      <option value="2" selected>2 Nodes</option>
      <option value="3">3 Nodes</option>
      <option value="4">4 Nodes</option>
      <option value="5">5 Nodes</option>
    </select>

    <button type="submit">üöÄ Run Distributed Test</button>
  </form>

  <!-- DASHBOARD -->
  <div class="charts">
    <div class="chart-box">
      <div class="chart-title">Average Response Time (ms)</div>
      <canvas id="latencyChart"></canvas>
    </div>
    <div class="chart-box">
      <div class="chart-title">Concurrency Over Time</div>
      <canvas id="concurrencyChart"></canvas>
    </div>
    <div class="chart-box">
      <div class="chart-title">Errors Per Second</div>
      <canvas id="errorsChart"></canvas>
    </div>
    <div class="chart-box">
      <div class="chart-title">Requests Per Second (RPS)</div>
      <canvas id="rpsChart"></canvas>
    </div>
  </div>

  <h3>üìä Request Metrics Summary</h3>
  <div class="table-container">
    <table id="metricsTable">
      <thead>
        <tr>
          <th>Request</th>
          <th>Count</th>
          <th>Fails</th>
          <th>Error %</th>
          <th>Avg (ms)</th>
          <th>P95 (ms)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <h3>ü™µ Live Logs</h3>
  <div id="logs">[Logs will appear here]</div>

  <script>
    const logs = document.getElementById('logs');
    const tableBody = document.querySelector('#metricsTable tbody');

    const makeChart = (id, label, color) => new Chart(document.getElementById(id), {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label,
          data: [],
          borderColor: color,
          backgroundColor: color + '33',
          fill: true,
          tension: 0.3,
          pointRadius: 1.8,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: { left: 8, right: 8, top: 5, bottom: 5 } },
        interaction: { mode: 'nearest', intersect: false },
        plugins: {
          tooltip: {
            enabled: true,
            backgroundColor: 'rgba(0,0,0,0.8)',
            titleFont: { weight: 'bold' },
            callbacks: {
              label: (ctx) => ` ${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}`
            }
          },
          legend: { display: true, labels: { usePointStyle: true, boxWidth: 10, font: { size: 11 } } }
        },
        scales: {
          x: {
            grid: { display: false },
            ticks: { color: '#555', font: { size: 11 } }
          },
          y: {
            beginAtZero: true,
            ticks: { color: '#555', font: { size: 11 } }
          }
        }
      }
    });

    const latencyChart = makeChart('latencyChart', 'Avg Response (ms)', '#007bff');
    const concurrencyChart = makeChart('concurrencyChart', 'Concurrency', '#28a745');
    const errorsChart = makeChart('errorsChart', 'Errors/sec', '#dc3545');
    const rpsChart = makeChart('rpsChart', 'Requests/sec', '#8000ff');

    const metrics = {};
    let reqs = 0, errs = 0, lastTick = Date.now();

    function updateCharts(ev) {
      const now = new Date().toLocaleTimeString();
      reqs++; if (ev.err) errs++;

      if (Date.now() - lastTick >= 1000) {
        const all = Object.values(metrics).flatMap(m => m.lat);
        const avg = all.reduce((a, b) => a + b, 0) / (all.length || 1);

        const add = (ch, val) => {
          ch.data.labels.push(now);
          ch.data.datasets[0].data.push(val);
          if (ch.data.labels.length > 60) {
            ch.data.labels.shift();
            ch.data.datasets[0].data.shift();
          }
          ch.update('none');
        };
        add(latencyChart, avg);
        add(concurrencyChart, ev.concurrency || 1);
        add(errorsChart, errs);
        add(rpsChart, reqs);
        reqs = 0; errs = 0; lastTick = Date.now();
      }
    }

    function updateTable(ev) {
      const key = ev.method + ' ' + ev.path;
      if (!metrics[key]) metrics[key] = { c: 0, f: 0, lat: [] };
      const m = metrics[key]; m.c++; if (ev.err) m.f++; m.lat.push(ev.latency_ms);
      const avg = m.lat.reduce((a, b) => a + b, 0) / m.lat.length;
      const sorted = [...m.lat].sort((a, b) => a - b);
      const p95 = sorted[Math.floor(sorted.length * 0.95)] || 0;
      const errPct = (m.f / m.c * 100).toFixed(2);
      let row = tableBody.querySelector(`[data-key="${key}"]`);
      if (!row) { row = document.createElement('tr'); row.dataset.key = key; tableBody.appendChild(row); }
      row.innerHTML = `<td>${key}</td><td>${m.c}</td><td>${m.f}</td><td>${errPct}%</td><td>${avg.toFixed(1)}</td><td>${p95.toFixed(1)}</td>`;
    }

    function connectSSE() {
      const es = new EventSource('/api/events');
      es.onmessage = e => {
        const ev = JSON.parse(e.data);

        if (ev.name === "RAMP_PROGRESS") {
          const now = new Date().toLocaleTimeString();
          concurrencyChart.data.labels.push(now);
          concurrencyChart.data.datasets[0].data.push(ev.concurrency);
          if (concurrencyChart.data.labels.length > 60) {
            concurrencyChart.data.labels.shift();
            concurrencyChart.data.datasets[0].data.shift();
          }
          concurrencyChart.update('none');
          logs.textContent += `\n‚öôÔ∏è ${ev.path} (${ev.concurrency} active users)`;
          logs.scrollTop = logs.scrollHeight;
          return;
        }

        logs.textContent += `\n${ev.method} ${ev.path} ‚Üí ${ev.status || '-'} (${ev.latency_ms.toFixed(1)}ms)`;
        logs.scrollTop = logs.scrollHeight;
        updateTable(ev);
        updateCharts(ev);
      };
      es.onerror = () => {
        logs.textContent += "\n‚ö†Ô∏è Connection lost. Reconnecting...";
        setTimeout(connectSSE, 3000);
      };
    }

    document.getElementById('runForm').addEventListener('submit', async e => {
      e.preventDefault();
      const file = document.getElementById('file').files[0];
      const nodes = document.getElementById('nodeCount').value;
      if (!file) return alert('Please select a YAML file first!');
      logs.textContent = `‚è≥ Uploading YAML and launching ${nodes} node(s)...\n`;
      const formData = new FormData();
      formData.append('file', file);
      formData.append('nodes', nodes);
      const res = await fetch('/api/run-distributed', { method: 'POST', body: formData });
      const data = await res.json();
      logs.textContent += "\n" + data.message;
    });

    connectSSE();
  </script>
</body>
</html>
