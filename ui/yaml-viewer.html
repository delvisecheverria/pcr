<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pulse YAML Visualizer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
<style>
  body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #ffffff;
    color: #222;
  }

  header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 16px;
    border-bottom: 1px solid #e5e7eb;
  }

  input[type="text"] {
    flex: 1;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
  }

  button, label {
    padding: 8px 14px;
    border: 1px solid #007bff;
    border-radius: 6px;
    background: #007bff;
    color: #fff;
    font-weight: 500;
    cursor: pointer;
  }

  button:hover, label:hover {
    background: #006ae6;
  }

  main {
    display: flex;
    height: calc(100vh - 56px);
  }

  #tree {
    width: 30%;
    border-right: 1px solid #e5e7eb;
    overflow-y: auto;
    padding: 16px;
  }

  #details {
    flex: 1;
    padding: 24px;
    overflow-y: auto;
    background: #fafafa;
  }

  ul {
    list-style: none;
    padding-left: 18px;
    margin: 0;
  }

  li {
    padding: 6px 4px;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: background 0.15s ease;
  }

  li:hover {
    background: #f0f4ff;
  }

  .icon {
    font-size: 12px;
    color: #555;
    transition: transform 0.2s ease;
  }

  .rotate {
    transform: rotate(90deg);
  }

  .section {
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #fff;
    padding: 12px;
    margin-bottom: 16px;
  }

  .section h3 {
    margin-top: 0;
    color: #007bff;
    font-size: 16px;
    border-bottom: 1px solid #eee;
    padding-bottom: 6px;
  }

  .kv {
    margin: 6px 0;
    padding-left: 8px;
  }

  .kv span.key {
    font-weight: 600;
    color: #333;
  }

  .kv span.value {
    color: #555;
  }

  pre {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
    overflow-x: auto;
    font-size: 13px;
  }

  .collapsed > ul {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.2s ease-out;
  }

  .expanded > ul {
    max-height: 800px;
    transition: max-height 0.25s ease-in;
  }
</style>
</head>
<body>
<header>
  <input id="yamlPath" type="text" placeholder="Enter YAML file name or path (e.g. example/test.yaml)">
  <button id="openBtn">Open</button>
  <label for="fileInput">Upload</label>
  <input id="fileInput" type="file" accept=".yaml,.yml" style="display:none;">
</header>

<main>
  <div id="tree"></div>
  <div id="details">
    <h2 style="color:#007bff;">No YAML loaded</h2>
    <p>Type a path and click <strong>Open</strong> or select a file with <strong>Upload</strong>.</p>
  </div>
</main>

<script>
const yamlPath = document.getElementById('yamlPath');
const openBtn = document.getElementById('openBtn');
const fileInput = document.getElementById('fileInput');
const treeEl = document.getElementById('tree');
const detailsEl = document.getElementById('details');
let yamlData = null;

async function loadYAMLFromServer(path) {
  const res = await fetch('/api/yaml/' + encodeURIComponent(path));
  if (!res.ok) {
    alert('Could not load YAML: ' + path);
    return;
  }
  const text = await res.text();
  parseAndRenderYAML(text);
}

fileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => parseAndRenderYAML(ev.target.result);
  reader.readAsText(file);
});

function parseAndRenderYAML(text) {
  try {
    yamlData = jsyaml.load(text);
    renderTree(yamlData);
  } catch (err) {
    alert('Error parsing YAML: ' + err.message);
  }
}

function renderTree(data) {
  treeEl.innerHTML = '';
  const root = document.createElement('ul');

  const scenarioLi = createNode('ðŸ§ª Scenario: ' + (data.scenario || 'Unnamed Scenario'), data, true);
  const threadLi = createNode('âš™ï¸ Thread Group', { concurrency: data.concurrency, duration: data.duration, ramp_up: data.ramp_up }, true);

  const requestsUl = document.createElement('ul');
  data.requests?.forEach((req, i) => {
    const reqLi = createNode(`ðŸŒ ${req.method} ${req.path}`, req, false);
    requestsUl.appendChild(reqLi);
  });

  threadLi.appendChild(requestsUl);
  scenarioLi.appendChild(threadLi);
  root.appendChild(scenarioLi);
  treeEl.appendChild(root);
}

function createNode(title, value, expanded = false) {
  const li = document.createElement('li');
  const icon = document.createElement('span');
  icon.className = 'icon';
  icon.textContent = expanded ? 'â–¼' : 'â–¶';
  if (expanded) icon.classList.add('rotate');

  const text = document.createElement('span');
  text.textContent = title;

  li.appendChild(icon);
  li.appendChild(text);

  li.onclick = (e) => {
    e.stopPropagation();
    const hasChildren = li.querySelector('ul');
    if (hasChildren) {
      const expandedNow = li.classList.toggle('expanded');
      li.classList.toggle('collapsed', !expandedNow);
      icon.textContent = expandedNow ? 'â–¼' : 'â–¶';
    }
    showDetails(title, value);
  };

  li.classList.add(expanded ? 'expanded' : 'collapsed');
  return li;
}

function showDetails(title, data) {
  detailsEl.innerHTML = '';

  const h2 = document.createElement('h2');
  h2.textContent = title;
  h2.style.color = '#007bff';
  detailsEl.appendChild(h2);

  if (data.concurrency || data.duration || data.ramp_up) {
    const section = document.createElement('div');
    section.className = 'section';
    section.innerHTML = '<h3>Thread Group</h3>';
    ['concurrency','duration','ramp_up'].forEach(k=>{
      if (data[k]) {
        const div = document.createElement('div');
        div.className = 'kv';
        div.innerHTML = `<span class="key">${k}:</span> <span class="value">${data[k]}</span>`;
        section.appendChild(div);
      }
    });
    detailsEl.appendChild(section);
  }

  if (data.method && data.path) {
    const info = document.createElement('div');
    info.className = 'section';
    info.innerHTML = '<h3>Request Info</h3>';
    ['name','method','protocol','host','path'].forEach(k=>{
      if (data[k]) {
        const div = document.createElement('div');
        div.className = 'kv';
        div.innerHTML = `<span class="key">${k}:</span> <span class="value">${data[k]}</span>`;
        info.appendChild(div);
      }
    });
    detailsEl.appendChild(info);
  }

  if (data.headers) {
    const headers = document.createElement('div');
    headers.className = 'section';
    headers.innerHTML = '<h3>Headers</h3>';
    for (const [key, val] of Object.entries(data.headers)) {
      const div = document.createElement('div');
      div.className = 'kv';
      div.innerHTML = `<span class="key">${key}:</span> <span class="value">${val}</span>`;
      headers.appendChild(div);
    }
    detailsEl.appendChild(headers);
  }

  if (data.body) {
    const body = document.createElement('div');
    body.className = 'section';
    body.innerHTML = '<h3>Body</h3>';
    const pre = document.createElement('pre');
    pre.textContent = data.body;
    body.appendChild(pre);
    detailsEl.appendChild(body);
  }
}

openBtn.onclick = () => {
  const path = yamlPath.value.trim();
  if (!path) return alert('Please type a YAML file name or path');
  loadYAMLFromServer(path);
};
</script>
</body>
</html>
